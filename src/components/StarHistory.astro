---
interface Props {
  repo: string;
  class?: string;
}

const { repo, class: className } = Astro.props;
const darkChartUrl = `https://api.star-history.com/svg?repos=${repo}&type=Date&theme=dark`;
const lightChartUrl = `https://api.star-history.com/svg?repos=${repo}&type=Date`;
---

<div class:list={["star-history", className]}>
  <div class="star-history-header">
    <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
      <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z" />
    </svg>
    <span>Star History</span>
  </div>
  <a href={`https://star-history.com/#${repo}&Date`} target="_blank" rel="noopener noreferrer" class="star-history-link">
    <img
      src={darkChartUrl}
      data-light-src={lightChartUrl}
      data-dark-src={darkChartUrl}
      alt={`Star history chart for ${repo}`}
      loading="lazy"
      class="star-history-img"
    />
  </a>
</div>

<script>
  function updateStarHistoryChart() {
    const img = document.querySelector('.star-history-img') as HTMLImageElement;
    if (!img) return;

    const theme = document.documentElement.getAttribute('data-theme');
    const src = theme === 'dark' ? img.dataset.darkSrc : img.dataset.lightSrc;
    if (src && img.src !== src) {
      img.src = src;
    }
  }

  // Run on load
  updateStarHistoryChart();

  // Watch for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        updateStarHistoryChart();
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });

  // Handle Astro page transitions
  document.addEventListener('astro:page-load', updateStarHistoryChart);
</script>

<style>
  .star-history {
    margin: 1.5rem 0;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--color-border);
  }

  .star-history-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-surface);
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .star-history-header svg {
    width: 16px;
    height: 16px;
    color: #f0c14b;
  }

  .star-history-link {
    display: block;
    line-height: 0;
    padding: 0;
    margin: 0;
  }

  :global([data-theme="dark"]) .star-history-link {
    background: #0d1117;
  }

  :global([data-theme="light"]) .star-history-link {
    background: #ffffff;
  }

  .star-history-img {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    padding: 0;
  }
</style>
