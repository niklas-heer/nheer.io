---
// Inky - The snarky tech octopus mascot (Lottie animation version)
import { getInkyComments } from "../utils/inky";

const comments = await getInkyComments(5);
---

<div class="inky-container" id="inky-container">
    <!-- Speech bubble (hidden by default) -->
    <div class="inky-bubble" id="inky-bubble">
        <p class="inky-text" id="inky-text"></p>
        <div class="inky-footer">
            <span class="inky-name">- Inky</span>
            <a
                class="inky-source"
                id="inky-source"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                title=""
            >
                <!-- Hacker News icon -->
                <svg
                    class="source-icon hn-icon"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M0 0v24h24V0H0zm12.3 12.5l3.6-6.5h1.7l-4.5 8v5.5h-1.6V14l-4.5-8h1.8l3.5 6.5z"
                    ></path>
                </svg>
                <!-- The New Stack icon (generic news/article icon) -->
                <svg
                    class="source-icon tns-icon"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                    ></path>
                </svg>
                <!-- DevOps.com icon (gear/cog icon) -->
                <svg
                    class="source-icon devops-icon"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"
                    ></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Inky the Octopus - Lottie Animation -->
    <button
        class="inky-mascot"
        id="inky-mascot"
        aria-label="Click Inky for a snarky tech comment"
        title="Click me!"
    >
        <div id="inky-lottie" class="inky-lottie"></div>
    </button>
</div>

<!-- Pass comments to JS -->
<script define:vars={{ comments }}>
    window.inkyComments = comments;
</script>

<script>
    import lottie from "lottie-web";

    function initInky() {
        const container = document.getElementById("inky-container");
        const mascot = document.getElementById("inky-mascot");
        const lottieContainer = document.getElementById("inky-lottie");
        const bubble = document.getElementById("inky-bubble");
        const text = document.getElementById("inky-text");
        const sourceLink = document.getElementById(
            "inky-source",
        ) as HTMLAnchorElement;

        // Skip if elements not found
        if (!mascot || !bubble || !text || !lottieContainer) return;

        // Clean up previous Lottie instance if exists
        lottie.destroy("inky-animation");

        // Initialize Lottie animation
        const anim = lottie.loadAnimation({
            container: lottieContainer,
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "/animations/octopus.json",
            name: "inky-animation",
        });

        // Clean up previous event listeners by cloning
        const newMascot = mascot.cloneNode(true) as HTMLElement;
        mascot.parentNode?.replaceChild(newMascot, mascot);

        // Re-append the lottie container to the new mascot
        const newLottieContainer = newMascot.querySelector("#inky-lottie");
        if (newLottieContainer) {
            lottie.destroy("inky-animation");
            lottie.loadAnimation({
                container: newLottieContainer as HTMLElement,
                renderer: "svg",
                loop: true,
                autoplay: true,
                path: "/animations/octopus.json",
                name: "inky-animation",
            });
        }

        let isActivated = false;
        let deactivateTimer: ReturnType<typeof setTimeout> | null = null;
        const DEACTIVATE_DELAY = 12000; // 12 seconds

        const comments = (window as any).inkyComments || [
            "I surfaced from the deep web just to judge your code.",
            "Your Docker containers are more tangled than my tentacles.",
            "I've seen cleaner git histories in the Mariana Trench.",
        ];

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray<T>(array: T[]): T[] {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Track shown comments - shuffle on init and cycle through
        let shuffledComments = shuffleArray(comments);
        let currentIndex = 0;
        let hasExhausted = false;

        const exhaustedMessages = [
            "That's all I've got... for now. My tentacles are tired.",
            "I've spilled all my ink! Check back tomorrow for fresh takes.",
            "You've drained my ocean of wisdom. Come back later!",
            "No more secrets from the deep. I need to recharge my snark.",
            "*blub blub* That's everything. Even octopuses need a break.",
        ];

        // Reset deactivation timer
        function resetDeactivateTimer() {
            if (deactivateTimer) {
                clearTimeout(deactivateTimer);
            }
            deactivateTimer = setTimeout(() => {
                if (isActivated) {
                    isActivated = false;
                    newMascot?.classList.remove("activated");
                    bubble?.classList.remove("visible");
                }
            }, DEACTIVATE_DELAY);
        }

        // Update source icon visibility and link
        function updateSourceIcon(comment: any) {
            if (!sourceLink) return;

            const sourceType = comment?.sourceType;
            const sourceUrl = comment?.sourceUrl;
            const sourceTitle = comment?.sourceTitle;

            // Hide all icons first
            sourceLink.querySelector(".hn-icon")?.classList.remove("visible");
            sourceLink.querySelector(".tns-icon")?.classList.remove("visible");
            sourceLink
                .querySelector(".devops-icon")
                ?.classList.remove("visible");

            // Only show for news comments with a URL
            if (sourceType && sourceType !== "general" && sourceUrl) {
                sourceLink.href = sourceUrl;
                sourceLink.title = sourceTitle || "Read article";
                sourceLink.style.display = "flex";

                // Show the appropriate icon
                if (sourceType === "hackernews") {
                    sourceLink
                        .querySelector(".hn-icon")
                        ?.classList.add("visible");
                } else if (sourceType === "thenewstack") {
                    sourceLink
                        .querySelector(".tns-icon")
                        ?.classList.add("visible");
                } else if (sourceType === "devops") {
                    sourceLink
                        .querySelector(".devops-icon")
                        ?.classList.add("visible");
                }
            } else {
                sourceLink.style.display = "none";
            }
        }

        // Show next comment in sequence, or exhausted message
        function showNextComment() {
            if (currentIndex < shuffledComments.length) {
                const comment = shuffledComments[currentIndex];
                if (text) text.textContent = comment.comment || comment;
                updateSourceIcon(comment);
                currentIndex++;
            } else if (!hasExhausted) {
                // First time exhausting - show exhausted message
                hasExhausted = true;
                const exhaustedMsg =
                    exhaustedMessages[
                        Math.floor(Math.random() * exhaustedMessages.length)
                    ];
                if (text) text.textContent = exhaustedMsg;
                updateSourceIcon(null); // Hide source for exhausted messages
            } else {
                // Already showed exhausted, just cycle the exhausted messages
                const exhaustedMsg =
                    exhaustedMessages[
                        Math.floor(Math.random() * exhaustedMessages.length)
                    ];
                if (text) text.textContent = exhaustedMsg;
                updateSourceIcon(null); // Hide source for exhausted messages
            }
            bubble?.classList.add("visible");
        }

        newMascot?.addEventListener("click", (e) => {
            e.stopPropagation();

            if (!isActivated) {
                // First click - activate Inky (he stays up)
                isActivated = true;
                newMascot.classList.add("activated");
            }

            // Show next comment in sequence
            showNextComment();

            // Reset timer on interaction
            resetDeactivateTimer();
        });

        // Reset timer when hovering
        newMascot?.addEventListener("mouseenter", () => {
            if (isActivated) {
                resetDeactivateTimer();
            }
        });

        // Close bubble when clicking outside, but keep Inky activated
        document.addEventListener("click", (e) => {
            if (!container?.contains(e.target as Node)) {
                bubble?.classList.remove("visible");
            }
        });
    }

    // Initialize on first load and after View Transitions navigation
    initInky();
    document.addEventListener("astro:page-load", initInky);
</script>

<style>
    .inky-container {
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 100;
        display: none;
    }

    @media (min-width: 1200px) {
        .inky-container {
            display: block;
        }
    }

    .inky-mascot {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        width: 200px;
        height: 200px;
        opacity: 0.6;
        transition:
            opacity 0.5s ease,
            transform 0.9s cubic-bezier(0.34, 1.56, 0.64, 1);
        /* Peek from left side, rotated so head/eyes show */
        transform: translateX(-90px) rotate(25deg);
        transform-origin: center center;
    }

    .inky-mascot:hover,
    .inky-mascot.activated {
        opacity: 1;
        /* Slide out and rotate to normal */
        transform: translateX(10px) rotate(0deg);
    }

    .inky-mascot:active {
        transform: translateX(10px) rotate(0deg) scale(0.97);
    }

    .inky-lottie {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 8px rgba(188, 62, 255, 0.3));
    }

    .inky-mascot:hover .inky-lottie,
    .inky-mascot.activated .inky-lottie {
        filter: drop-shadow(0 0 15px rgba(188, 62, 255, 0.5));
    }

    /* Speech bubble */
    .inky-bubble {
        position: absolute;
        bottom: 180px;
        left: 80px;
        background: var(--color-surface);
        border: 2px solid #bc3eff;
        border-radius: 1rem;
        padding: 1rem;
        max-width: 280px;
        min-width: 200px;
        box-shadow:
            0 0 20px rgba(188, 62, 255, 0.2),
            0 4px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px) scale(0.95);
        transition: all 0.2s ease;
    }

    .inky-bubble.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    /* Bubble arrow */
    .inky-bubble::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 40px;
        border-width: 10px 10px 0;
        border-style: solid;
        border-color: var(--color-surface) transparent transparent;
    }

    .inky-bubble::before {
        content: "";
        position: absolute;
        bottom: -14px;
        left: 38px;
        border-width: 12px 12px 0;
        border-style: solid;
        border-color: #bc3eff transparent transparent;
    }

    .inky-text {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--color-foreground);
    }

    .inky-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.5rem;
    }

    .inky-name {
        font-size: 0.75rem;
        color: #bc3eff;
        font-style: italic;
    }

    .inky-source {
        display: none;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        color: var(--color-foreground);
        opacity: 0.6;
        transition:
            opacity 0.2s ease,
            color 0.2s ease;
    }

    .inky-source:hover {
        opacity: 1;
        color: #bc3eff;
    }

    .source-icon {
        display: none;
        width: 16px;
        height: 16px;
    }

    .source-icon.visible {
        display: block;
    }
</style>
